<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coffee Game – Snake & Pac-Man Duel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    :root {
      --espresso: #2a1f1f;
      --roast: #3b2f2f;
      --medium: #4a3a2f;
      --latte: #6b4f3a;
      --cream: #d7c4a3;
      --foam: #f5eee6;
      --accent: #f2b36f;
      --accent-soft: #f7cfa0;
      --border-soft: #5a4636;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #4a3a2f 0%, #2a1f1f 45%, #1b1412 100%);
      color: var(--foam);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin: 16px 0 8px;
      font-size: 26px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--foam);
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }
    .subtitle {
      font-size: 12px;
      color: var(--cream);
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .container {
      width: 100%;
      max-width: 1040px;
      padding: 16px;
    }
    .card {
      background: rgba(59,47,47,0.9);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .col {
      flex: 1;
      min-width: 260px;
    }
    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--cream);
      margin-bottom: 4px;
      opacity: 0.8;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(26,19,19,0.9);
      color: var(--foam);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    textarea {
      border-radius: 10px;
      resize: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(242,179,111,0.5);
      background: rgba(26,19,19,1);
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-soft) 100%);
      color: #3b2f2f;
      font-weight: 600;
      text-shadow: 0 1px 0 rgba(255,255,255,0.4);
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
      background: rgba(80,60,50,0.8);
      border-color: rgba(120,90,70,0.8);
      color: var(--cream);
      text-shadow: none;
    }
    .panel {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: rgba(26,19,19,0.9);
      padding: 8px;
      min-height: 80px;
    }
    #profileCard {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #profileEmoji {
      font-size: 34px;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.6));
    }
    #profileName {
      font-weight: 700;
      font-size: 15px;
      color: var(--foam);
    }
    #profileCodename {
      font-size: 11px;
      color: var(--cream);
      opacity: 0.9;
    }
    #serverList button {
      margin-top: 4px;
      text-align: left;
      font-size: 13px;
      border-radius: 8px;
      background: linear-gradient(135deg, #6b4f3a 0%, #4a3a2f 100%);
      color: var(--foam);
      text-shadow: none;
      border-color: rgba(215,196,163,0.4);
    }
    #serverList button span.host {
      font-weight: 700;
    }
    #serverList button span.code {
      font-size: 11px;
      opacity: 0.9;
    }
    #serverListEmpty {
      font-size: 12px;
      color: var(--cream);
      opacity: 0.8;
    }
    #gameCanvas {
      background: #1b1412;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      image-rendering: pixelated;
      display: block;
      margin: 0 auto;
    }
    #gameInfo {
      font-size: 12px;
      color: var(--cream);
      margin-top: 6px;
      min-height: 32px;
    }
    #chatLog {
      height: 180px;
      font-size: 12px;
      background: rgba(26,19,19,0.9);
      color: var(--foam);
    }
    #chatInput {
      margin-top: 4px;
    }
    .screen {
      display: none;
      animation: fadeIn 0.25s ease-out;
    }
    .screen.active {
      display: block;
    }
    .centered {
      text-align: center;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(215,196,163,0.5);
      font-size: 11px;
      color: var(--cream);
      margin-left: 4px;
    }
    .btn-secondary {
      background: rgba(26,19,19,0.9);
      border-color: rgba(215,196,163,0.5);
      color: var(--cream);
      text-shadow: none;
    }
    .btn-secondary:hover:not(:disabled) {
      background: rgba(40,30,25,0.95);
    }
    .inline {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .inline > * {
      flex: 1;
    }
    .small-note {
      font-size: 11px;
      color: var(--cream);
      opacity: 0.8;
      margin-top: 4px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1>COFFEE GAME</h1>
  <div class="subtitle">Multiplayer coffee lobby with Snake & PacMan Duel</div>
  <div class="container">
    <div class="card">
      <!-- SCREEN: BOOT -->
      <div id="screenBoot" class="screen active">
        <div class="row">
          <div class="col">
            <div class="section-title">Player name</div>
            <input id="nameInput" maxlength="20" placeholder="Name (letters, numbers, spaces)" />
          </div>
          <div class="col">
            <div class="section-title">Emoji PFP</div>
            <input id="emojiInput" maxlength="4" placeholder="" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <button id="makeCoffeeBtn">Make Coffee (Host)</button>
          </div>
          <div class="col">
            <button id="getCoffeeBtn" class="btn-secondary">Get Coffee (Join)</button>
          </div>
        </div>
        <div class="small-note centered">
          Your device codename will be shared with the room.<br />
          It’s part of Coffee Game canon.
        </div>
      </div>

      <!-- SCREEN: HOST LOBBY -->
      <div id="screenHostLobby" class="screen">
        <div class="row">
          <div class="col">
            <div class="section-title">Your profile</div>
            <div class="panel">
              <div id="profileCardHost">
                <div id="profileEmojiHost"></div>
                <div>
                  <div id="profileNameHost">Host</div>
                  <div id="profileCodenameHost">Codename: Unknown</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="section-title">Room status</div>
            <div class="panel" id="hostStatusPanel">
              <div id="hostStatusText">Waiting for a player to Get Coffee…</div>
              <div class="small-note">
                Once a player joins, you can pick Snake or PacMan Duel.
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="section-title">Game selection</div>
            <select id="gameSelect" disabled>
              <option value="">Select a game…</option>
              <option value="snake">Snake (Starvation)</option>
              <option value="pacman">Pac-Man Duel</option>
            </select>
          </div>
          <div class="col">
            <div class="section-title">Controls</div>
            <div class="panel">
              <div class="small-note">
                Snake: Arrow keys<br />
                PacMan Duel: Player 1 – Arrow keys, Player 2 – WASD
              </div>
            </div>
          </div>
        </div>
        <div class="row centered">
          <div class="col">
            <button id="hostBackBtn" class="btn-secondary">Back to Coffee Counter</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: SERVER LIST (JOINER) -->
      <div id="screenServerList" class="screen">
        <div class="row">
          <div class="col">
            <div class="section-title">Your profile</div>
            <div class="panel">
              <div id="profileCardJoin">
                <div id="profileEmojiJoin"></div>
                <div>
                  <div id="profileNameJoin">Joiner</div>
                  <div id="profileCodenameJoin">Codename: Unknown</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="section-title inline">
              <span>Available coffee rooms</span>
              <button id="refreshRoomsBtn" class="btn-secondary" style="max-width:120px;">Refresh</button>
            </div>
            <div class="panel" id="serverList">
              <div id="serverListEmpty">No servers yet. Ask a friend to Make Coffee.</div>
            </div>
          </div>
        </div>
        <div class="row centered">
          <div class="col">
            <button id="joinBackBtn" class="btn-secondary">Back to Coffee Counter</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: JOINER LOBBY -->
      <div id="screenJoinLobby" class="screen">
        <div class="row">
          <div class="col">
            <div class="section-title">Host</div>
            <div class="panel">
              <div id="joinLobbyHost">
                <div>Host: <span id="joinLobbyHostName">Unknown</span></div>
                <div class="small-note">Codename: <span id="joinLobbyHostCode">Unknown</span></div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="section-title">You</div>
            <div class="panel">
              <div id="joinLobbyYou">
                <div>You: <span id="joinLobbyYouName">Unknown</span></div>
                <div class="small-note">Codename: <span id="joinLobbyYouCode">Unknown</span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="section-title">Status</div>
            <div class="panel">
              <div id="joinLobbyStatus">Waiting for host to pick a game…</div>
            </div>
          </div>
          <div class="col">
            <div class="section-title">Controls</div>
            <div class="panel">
              <div class="small-note">
                Snake: Arrow keys (host or joiner, depending on room rules).<br />
                PacMan Duel: Player 1 – Arrow keys, Player 2 – WASD.
              </div>
            </div>
          </div>
        </div>
        <div class="row centered">
          <div class="col">
            <button id="joinLobbyBackBtn" class="btn-secondary">Leave Room</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: GAME -->
      <div id="screenGame" class="screen">
        <div class="row">
          <div class="col">
            <div class="section-title">Game</div>
            <div class="panel">
              <canvas id="gameCanvas" width="448" height="448"></canvas>
              <div id="gameInfo"></div>
            </div>
          </div>
          <div class="col">
            <div class="section-title">Chat</div>
            <textarea id="chatLog" readonly></textarea>
            <input id="chatInput" placeholder="Type message and press Enter" />
            <div class="small-note">
              Messages include your codename so everyone knows who’s brewing from where.
            </div>
          </div>
        </div>
        <div class="row centered">
          <div class="col">
            <button id="gameBackBtn" class="btn-secondary">Leave Game</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // ===== CODENAME RESOLVER (COFFEE GAME CANON) =====
    function detectCodename() {
      const ua = navigator.userAgent || "";
      const lower = ua.toLowerCase();

      if (lower.includes("android")) {
        const m = ua.match(/Android\s+([0-9]+(?:\.[0-9]+)?)/i);
        const v = m ? m[1] : "";
        if (v.startsWith("9")) return "Android Pie";
        if (v.startsWith("10")) return "Android Quince";
        if (v.startsWith("11")) return "Android Red Velvet";
        if (v.startsWith("12")) return "Android Snowcone";
        if (v.startsWith("13")) return "Android Tiramisu";
        if (v.startsWith("14")) return "Android Upside-down Cake";
        if (v.startsWith("15")) return "Android Vanilla";
        if (v.startsWith("16")) return "Android Wisteria";
        return "Android";
      }

      if (/iPhone|iPad|iPod/i.test(ua)) {
        const m = ua.match(/OS\s([0-9]+)_/i);
        const major = m ? parseInt(m[1], 10) : 0;
        if (major === 14) return "iOS Azul";
        if (major === 15) return "iOS Sky";
        if (major === 16) return "iOS Sydney";
        if (major === 17) return "iOS Dawn";
        if (major === 18) return "iOS Crystal";
        return "iOS";
      }

      if (lower.includes("windows nt 10.0")) return "Windows Threshold";
      if (lower.includes("windows nt 6.3")) return "Windows Blue";
      if (lower.includes("windows nt 6.1")) return "Windows Blackcomb";
      if (lower.includes("windows")) return "Windows";

      if (lower.includes("mac os x")) {
        if (lower.includes("10_15")) return "macOS Catalina";
        if (lower.includes("10_14")) return "macOS Mojave";
        if (lower.includes("10_13")) return "macOS High Sierra";
        if (lower.includes("10_12")) return "macOS Sierra";
        if (lower.includes("10_11")) return "macOS El Capitan";
        if (lower.includes("10_10")) return "macOS Yosemite";
        if (lower.includes("10_9")) return "macOS Mavericks";
        return "macOS";
      }

      if (lower.includes("cros")) return "ChromeOS";
      if (lower.includes("linux")) return "Linux";
      return "Unknown";
    }

    // ===== BASIC VALIDATION =====
    function isValidName(name) {
      if (!name) return false;
      if (name.length > 20) return false;
      return /^[A-Za-z0-9 ]+$/.test(name.trim());
    }

    function isSingleEmoji(str) {
      if (!str) return false;
      const t = str.trim();
      if (!t || t.length > 4) return false;
      return !/[A-Za-z0-9]/.test(t);
    }

    // ===== DOM =====
    const screenBoot = document.getElementById("screenBoot");
    const screenHostLobby = document.getElementById("screenHostLobby");
    const screenServerList = document.getElementById("screenServerList");
    const screenJoinLobby = document.getElementById("screenJoinLobby");
    const screenGame = document.getElementById("screenGame");

    const nameInput = document.getElementById("nameInput");
    const emojiInput = document.getElementById("emojiInput");
    const makeCoffeeBtn = document.getElementById("makeCoffeeBtn");
    const getCoffeeBtn = document.getElementById("getCoffeeBtn");

    const profileEmojiHost = document.getElementById("profileEmojiHost");
    const profileNameHost = document.getElementById("profileNameHost");
    const profileCodenameHost = document.getElementById("profileCodenameHost");

    const profileEmojiJoin = document.getElementById("profileEmojiJoin");
    const profileNameJoin = document.getElementById("profileNameJoin");
    const profileCodenameJoin = document.getElementById("profileCodenameJoin");

    const hostStatusText = document.getElementById("hostStatusText");
    const gameSelect = document.getElementById("gameSelect");

    const serverList = document.getElementById("serverList");
    const serverListEmpty = document.getElementById("serverListEmpty");
    const refreshRoomsBtn = document.getElementById("refreshRoomsBtn");

    const joinLobbyHostName = document.getElementById("joinLobbyHostName");
    const joinLobbyHostCode = document.getElementById("joinLobbyHostCode");
    const joinLobbyYouName = document.getElementById("joinLobbyYouName");
    const joinLobbyYouCode = document.getElementById("joinLobbyYouCode");
    const joinLobbyStatus = document.getElementById("joinLobbyStatus");

    const hostBackBtn = document.getElementById("hostBackBtn");
    const joinBackBtn = document.getElementById("joinBackBtn");
    const joinLobbyBackBtn = document.getElementById("joinLobbyBackBtn");
    const gameBackBtn = document.getElementById("gameBackBtn");

    const gameCanvas = document.getElementById("gameCanvas");
    const gameInfo = document.getElementById("gameInfo");
    const chatLog = document.getElementById("chatLog");
    const chatInput = document.getElementById("chatInput");

    const ctx = gameCanvas.getContext("2d");
    const deviceCodename = detectCodename();

    function showScreen(id) {
      [screenBoot, screenHostLobby, screenServerList, screenJoinLobby, screenGame].forEach(s => {
        s.classList.remove("active");
      });
      id.classList.add("active");
    }

    function updateButtons() {
      const ok = isValidName(nameInput.value) && isSingleEmoji(emojiInput.value);
      makeCoffeeBtn.disabled = !ok;
      getCoffeeBtn.disabled = !ok;
    }

    function updateProfiles() {
      const name = isValidName(nameInput.value) ? nameInput.value.trim() : "Player";
      const emoji = emojiInput.value.trim() || "";

      profileEmojiHost.textContent = emoji;
      profileNameHost.textContent = name;
      profileCodenameHost.textContent = "Codename: " + deviceCodename;

      profileEmojiJoin.textContent = emoji;
      profileNameJoin.textContent = name;
      profileCodenameJoin.textContent = "Codename: " + deviceCodename;

      joinLobbyYouName.textContent = name;
      joinLobbyYouCode.textContent = deviceCodename;
    }

    nameInput.addEventListener("input", () => {
      updateButtons();
      updateProfiles();
    });
    emojiInput.addEventListener("input", () => {
      updateButtons();
      updateProfiles();
    });

    updateButtons();
    updateProfiles();

    // ===== SOCKET =====
    const socket = io("https://c3l3st1n3k1w1.onrender.com");
    let currentRoomId = null;
    let isHost = false;
    let autoRefreshInterval = null;

    function renderServerList(rooms) {
      serverList.innerHTML = "";
      if (!rooms || rooms.length === 0) {
        serverList.appendChild(serverListEmpty);
        serverListEmpty.style.display = "block";
        return;
      }
      serverListEmpty.style.display = "none";
      rooms.forEach(room => {
        const btn = document.createElement("button");
        const codename = room.platform || "Unknown";
        btn.innerHTML = `
          <span class="host">${room.name}</span>
          <span class="code"> · ${codename}</span>
        `;
        btn.onclick = () => joinRoom(room.id, room);
        serverList.appendChild(btn);
      });
    }

    socket.on("connect", () => {
      // nothing yet; we fetch rooms when needed
    });

    socket.on("rooms", rooms => {
      renderServerList(rooms);
    });

    socket.on("room-created", room => {
      currentRoomId = room.id;
      isHost = true;
      hostStatusText.textContent = "Waiting for a player to Get Coffee…";
      gameSelect.disabled = true;
      showScreen(screenHostLobby);
    });

    socket.on("joined-room", room => {
      currentRoomId = room.id;
      isHost = false;
      joinLobbyHostName.textContent = room.hostName || "Host";
      joinLobbyHostCode.textContent = room.platform || "Unknown";
      joinLobbyStatus.textContent = "Waiting for host to pick a game…";
      showScreen(screenJoinLobby);
    });

    socket.on("chat", msg => {
      chatLog.value += msg + "\n";
      chatLog.scrollTop = chatLog.scrollHeight;
    });

    socket.on("game-selected", gameId => {
      loadGame(gameId);
      showScreen(screenGame);
    });

    // ===== ACTIONS =====
    function makeRoom() {
      if (!isValidName(nameInput.value) || !isSingleEmoji(emojiInput.value)) return;
      updateProfiles();
      socket.emit("host-room", {
        name: nameInput.value.trim(),
        emoji: emojiInput.value.trim(),
        platform: deviceCodename
      });
    }

    function requestRooms() {
      socket.emit("list-rooms");
    }

    function joinRoom(roomId, roomMeta) {
      socket.emit("join-room", {
        roomId,
        name: nameInput.value.trim(),
        emoji: emojiInput.value.trim(),
        platform: deviceCodename
      });
      if (roomMeta) {
        joinLobbyHostName.textContent = roomMeta.name || "Host";
        joinLobbyHostCode.textContent = roomMeta.platform || "Unknown";
      }
    }

    makeCoffeeBtn.addEventListener("click", () => {
      makeRoom();
    });

    getCoffeeBtn.addEventListener("click", () => {
      updateProfiles();
      showScreen(screenServerList);
      requestRooms();
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = setInterval(requestRooms, 4000);
    });

    refreshRoomsBtn.addEventListener("click", () => {
      requestRooms();
    });

    hostBackBtn.addEventListener("click", () => {
      socket.emit("leave-room", { roomId: currentRoomId });
      currentRoomId = null;
      isHost = false;
      showScreen(screenBoot);
    });

    joinBackBtn.addEventListener("click", () => {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      showScreen(screenBoot);
    });

    joinLobbyBackBtn.addEventListener("click", () => {
      socket.emit("leave-room", { roomId: currentRoomId });
      currentRoomId = null;
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      showScreen(screenServerList);
      requestRooms();
    });

    gameBackBtn.addEventListener("click", () => {
      socket.emit("leave-room", { roomId: currentRoomId });
      currentRoomId = null;
      if (isHost) {
        showScreen(screenHostLobby);
      } else {
        showScreen(screenServerList);
        requestRooms();
      }
    });

    // ===== GAME SELECT =====
    gameSelect.addEventListener("change", () => {
      if (!isHost || !currentRoomId) return;
      const gameId = gameSelect.value;
      if (!gameId) return;
      socket.emit("select-game", { roomId: currentRoomId, gameId });
      loadGame(gameId);
      showScreen(screenGame);
    });

    // ===== SNAKE (STARVATION MODE) =====
    const GRID_SIZE = 28;
    const TILE = 16;
    let snakeActive = false;
    let snakeDir = { x: 1, y: 0 };
    let snakeBody = [];
    let snakeApples = [];
    let snakeStarveCounter = 0;
    let snakeAlive = true;

    function resetSnake() {
      snakeActive = true;
      snakeDir = { x: 1, y: 0 };
      snakeBody = [
        { x: 5, y: 14 },
        { x: 4, y: 14 },
        { x: 3, y: 14 }
      ];
      snakeApples = [];
      for (let i = 0; i < 12; i++) spawnApple();
      snakeStarveCounter = 0;
      snakeAlive = true;
      gameInfo.textContent =
        "Snake (Starvation): Move constantly. Each step without eating increases starvation; too much and you lose segments.";
    }

    function spawnApple() {
      let x, y, bad;
      do {
        x = Math.floor(Math.random() * GRID_SIZE);
        y = Math.floor(Math.random() * GRID_SIZE);
        bad = snakeBody.some(s => s.x === x && s.y === y) ||
              snakeApples.some(a => a.x === x && a.y === y);
      } while (bad);
      snakeApples.push({ x, y });
    }

    function updateSnake() {
      if (!snakeActive || !snakeAlive) return;
      const head = snakeBody[0];
      const nx = head.x + snakeDir.x;
      const ny = head.y + snakeDir.y;

      if (nx < 0 || ny < 0 || nx >= GRID_SIZE || ny >= GRID_SIZE) {
        snakeAlive = false;
        gameInfo.textContent = "Snake: You hit a wall. Starved snake dies.";
        return;
      }

      if (snakeBody.some(s => s.x === nx && s.y === ny)) {
        snakeAlive = false;
        gameInfo.textContent = "Snake: You bit yourself. Game over.";
        return;
      }

      const newHead = { x: nx, y: ny };
      snakeBody.unshift(newHead);

      const appleIndex = snakeApples.findIndex(a => a.x === nx && a.y === ny);
      if (appleIndex >= 0) {
        snakeApples.splice(appleIndex, 1);
        spawnApple();
        snakeStarveCounter = 0;
      } else {
        snakeStarveCounter++;
        if (snakeStarveCounter >= 10) {
          snakeBody.pop();
          snakeStarveCounter = 0;
          if (snakeBody.length <= 2) {
            snakeAlive = false;
            gameInfo.textContent = "Snake: You starved away to nothing.";
            return;
          }
        } else {
          snakeBody.pop();
        }
      }
    }

    function drawSnake() {
      ctx.fillStyle = "#1b1412";
      ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

      ctx.fillStyle = "#f2b36f";
      snakeApples.forEach(a => {
        ctx.beginPath();
        ctx.arc(
          a.x * TILE + TILE / 2,
          a.y * TILE + TILE / 2,
          TILE / 2 - 2,
          0,
          Math.PI * 2
        );
        ctx.fill();
      });

      snakeBody.forEach((s, i) => {
        ctx.fillStyle = i === 0 ? "#9be15d" : "#6bbf3a";
        ctx.fillRect(s.x * TILE + 1, s.y * TILE + 1, TILE - 2, TILE - 2);
      });
    }

    // ===== PAC-MAN DUEL =====
    const PM_GRID = 28;
    const PM_TILE = 16;

    let pacActive = false;
    let pacPlayers = [];
    let pacGhosts = [];
    let pacPellets = [];
    let pacTick = 0;

    function resetPacman() {
      pacActive = true;
      pacTick = 0;
      pacPlayers = [
        {
          id: 0,
          x: 13,
          y: 20,
          dir: { x: 0, y: -1 },
          hearts: 10,
          color: "#ffeb3b",
          input: { up: false, down: false, left: false, right: false }
        },
        {
          id: 1,
          x: 14,
          y: 20,
          dir: { x: 0, y: -1 },
          hearts: 10,
          color: "#80deea",
          input: { up: false, down: false, left: false, right: false }
        }
      ];
      pacGhosts = [];
      for (let i = 0; i < 16; i++) {
        pacGhosts.push({
          x: 10 + (i % 4),
          y: 10 + Math.floor(i / 4),
          dir: { x: 0, y: 1 },
          color: ["#ff5252", "#f48fb1", "#69f0ae", "#ffb74d"][i % 4]
        });
      }
      pacPellets = [];
      for (let y = 2; y < PM_GRID - 2; y++) {
        for (let x = 2; x < PM_GRID - 2; x++) {
          if ((x + y) % 2 === 0) pacPellets.push({ x, y, eaten: false });
        }
      }
      gameInfo.textContent =
        "Pac-Man Duel: 2 Pac-Men, 16 ghosts, 10 hearts each. Directional bites; knockback when facing each other.";
    }

    function handlePacInput() {
      pacPlayers.forEach(p => {
        if (p.input.up) p.dir = { x: 0, y: -1 };
        else if (p.input.down) p.dir = { x: 0, y: 1 };
        else if (p.input.left) p.dir = { x: -1, y: 0 };
        else if (p.input.right) p.dir = { x: 1, y: 0 };
      });
    }

    function movePacPlayers() {
      pacPlayers.forEach(p => {
        p.x += p.dir.x;
        p.y += p.dir.y;
        if (p.x < 0) p.x = PM_GRID - 1;
        if (p.x >= PM_GRID) p.x = 0;
        if (p.y < 0) p.y = PM_GRID - 1;
        if (p.y >= PM_GRID) p.y = 0;
      });
    }

    function moveGhosts() {
      pacGhosts.forEach(g => {
        if (Math.random() < 0.2) {
          const dirs = [
            { x: 1, y: 0 },
            { x: -1, y: 0 },
            { x: 0, y: 1 },
            { x: 0, y: -1 }
          ];
          g.dir = dirs[Math.floor(Math.random() * dirs.length)];
        }
        g.x += g.dir.x;
        g.y += g.dir.y;
        if (g.x < 0) g.x = PM_GRID - 1;
        if (g.x >= PM_GRID) g.x = 0;
        if (g.y < 0) g.y = PM_GRID - 1;
        if (g.y >= PM_GRID) g.y = 0;
      });
    }

    function eatPellets() {
      pacPlayers.forEach(p => {
        pacPellets.forEach(pe => {
          if (!pe.eaten && pe.x === p.x && pe.y === p.y) {
            pe.eaten = true;
          }
        });
      });
    }

    function pacFacing(a, b) {
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      return (dx === a.dir.x && dy === a.dir.y);
    }

    function pacFacingEachOther(a, b) {
      return pacFacing(a, b) && pacFacing(b, a);
    }

    function pacSameTile(a, b) {
      return a.x === b.x && a.y === b.y;
    }

    function resolvePacCombat() {
      const p0 = pacPlayers[0];
      const p1 = pacPlayers[1];

      if (!pacSameTile(p0, p1)) return;

      if (pacFacingEachOther(p0, p1)) {
        knockback(p0, p1, true);
        return;
      }

      const p0FacingP1 = pacFacing(p0, p1);
      const p1FacingP0 = pacFacing(p1, p0);

      if (p0FacingP1 && !p1FacingP0) {
        bite(p0, p1);
      } else if (p1FacingP0 && !p0FacingP1) {
        bite(p1, p0);
      }
    }

    function bite(attacker, defender) {
      defender.hearts = Math.max(0, defender.hearts - 1);
      knockback(defender, attacker, false);
      if (defender.hearts === 0) {
        gameInfo.textContent =
          "Pac-Man Duel: " + (attacker.id === 0 ? "Player 1" : "Player 2") + " wins (hearts depleted).";
        pacActive = false;
      }
    }

    function knockback(target, source, both) {
      const dx = target.x - source.x;
      const dy = target.y - source.y;
      let kx = 0, ky = 0;
      if (Math.abs(dx) > Math.abs(dy)) kx = dx > 0 ? 1 : -1;
      else if (Math.abs(dy) > 0) ky = dy > 0 ? 1 : -1;

      target.x += kx;
      target.y += ky;
      if (target.x < 0) target.x = PM_GRID - 1;
      if (target.x >= PM_GRID) target.x = 0;
      if (target.y < 0) target.y = PM_GRID - 1;
      if (target.y >= PM_GRID) target.y = 0;

      if (both) {
        source.x -= kx;
        source.y -= ky;
        if (source.x < 0) source.x = PM_GRID - 1;
        if (source.x >= PM_GRID) source.x = 0;
        if (source.y < 0) source.y = PM_GRID - 1;
        if (source.y >= PM_GRID) source.y = 0;
      }
    }

    function drawPacman() {
      ctx.fillStyle = "#1b1412";
      ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

      ctx.fillStyle = "#3b2f2f";
      for (let y = 0; y < PM_GRID; y++) {
        for (let x = 0; x < PM_GRID; x++) {
          ctx.fillRect(x * PM_TILE, y * PM_TILE, 1, 1);
        }
      }

      ctx.fillStyle = "#f5eee6";
      pacPellets.forEach(pe => {
        if (!pe.eaten) {
          ctx.beginPath();
          ctx.arc(
            pe.x * PM_TILE + PM_TILE / 2,
            pe.y * PM_TILE + PM_TILE / 2,
            2,
            0,
            Math.PI * 2
          );
          ctx.fill();
        }
      });

      pacGhosts.forEach(g => {
        ctx.fillStyle = g.color;
        ctx.fillRect(g.x * PM_TILE + 2, g.y * PM_TILE + 2, PM_TILE - 4, PM_TILE - 4);
      });

      pacPlayers.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(
          p.x * PM_TILE + PM_TILE / 2,
          p.y * PM_TILE + PM_TILE / 2,
          PM_TILE / 2 - 1,
          0,
          Math.PI * 2
        );
        ctx.fill();
      });

      ctx.fillStyle = "#f5eee6";
      ctx.font = "10px Nunito";
      ctx.fillText("P1 Hearts: " + pacPlayers[0].hearts, 4, 12);
      ctx.fillText("P2 Hearts: " + pacPlayers[1].hearts, 4, 24);
    }

    function updatePacman() {
      if (!pacActive) return;
      pacTick++;
      if (pacTick % 4 === 0) {
        handlePacInput();
        movePacPlayers();
        eatPellets();
        moveGhosts();
        resolvePacCombat();
      }
    }

    // ===== GAME LOOP =====
    let currentGame = null;

    function loadGame(gameId) {
      currentGame = gameId;
      if (gameId === "snake") {
        resetSnake();
      } else if (gameId === "pacman") {
        resetPacman();
      } else {
        ctx.fillStyle = "#1b1412";
        ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
        gameInfo.textContent = "Waiting for game selection…";
      }
    }

    function loop() {
      requestAnimationFrame(loop);
      if (currentGame === "snake") {
        updateSnake();
        drawSnake();
      } else if (currentGame === "pacman") {
        updatePacman();
        drawPacman();
      }
    }
    loop();

    // ===== INPUT HANDLING =====
    window.addEventListener("keydown", e => {
      if (currentGame === "snake") {
        if (e.key === "ArrowUp" && snakeDir.y !== 1) snakeDir = { x: 0, y: -1 };
        else if (e.key === "ArrowDown" && snakeDir.y !== -1) snakeDir = { x: 0, y: 1 };
        else if (e.key === "ArrowLeft" && snakeDir.x !== 1) snakeDir = { x: -1, y: 0 };
        else if (e.key === "ArrowRight" && snakeDir.x !== -1) snakeDir = { x: 1, y: 0 };
      } else if (currentGame === "pacman") {
        const p0 = pacPlayers[0];
        const p1 = pacPlayers[1];
        if (!p0 || !p1) return;

        if (e.key === "ArrowUp") { p0.input = { up: true, down: false, left: false, right: false }; }
        else if (e.key === "ArrowDown") { p0.input = { up: false, down: true, left: false, right: false }; }
        else if (e.key === "ArrowLeft") { p0.input = { up: false, down: false, left: true, right: false }; }
        else if (e.key === "ArrowRight") { p0.input = { up: false, down: false, left: false, right: true }; }

        if (e.key === "w") { p1.input = { up: true, down: false, left: false, right: false }; }
        else if (e.key === "s") { p1.input = { up: false, down: true, left: false, right: false }; }
        else if (e.key === "a") { p1.input = { up: false, down: false, left: true, right: false }; }
        else if (e.key === "d") { p1.input = { up: false, down: false, left: false, right: true }; }
      }
    });

    // ===== CHAT =====
    chatInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text || !currentRoomId) return;
        socket.emit("chat", {
          roomId: currentRoomId,
          text,
          from: nameInput.value.trim(),
          codename: deviceCodename
        });
        chatInput.value = "";
      }
    });
  </script>
</body>
</html>