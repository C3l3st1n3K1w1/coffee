<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coffeeâ˜•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CoffeeScript compiler (runs in browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.12.7/coffee-script.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #3b241a 0, #120806 55%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fdf5e6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .coffee-shell {
      background: #2b1a14;
      border-radius: 16px;
      padding: 16px 20px 20px;
      width: 360px;
      box-shadow: 0 0 24px rgba(0, 0, 0, 0.6);
      border: 1px solid #3a241a;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 22px;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #3a241a;
      background: #3a241a;
      color: #fdf5e6;
      font-size: 14px;
    }

    input::placeholder {
      color: #a88a72;
    }

    button {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #f5c38b;
      color: #2b1a14;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
      background: #ffd19f;
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .profile {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #241510;
      border: 1px solid #3a241a;
      font-size: 14px;
    }

    .profile-line {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .profile-emoji {
      font-size: 20px;
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #c9b39a;
      min-height: 16px;
    }

    .game-panel {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #3a241a;
      display: none;
    }

    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #3a241a;
      background: #3a241a;
      color: #fdf5e6;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .chat-shell {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #241510;
      border: 1px solid #3a241a;
      font-size: 12px;
    }

    .chat-log {
      max-height: 80px;
      overflow-y: auto;
      margin-bottom: 4px;
    }

    .chat-input-row {
      display: flex;
      gap: 4px;
    }

    .chat-input-row input {
      font-size: 12px;
      padding: 4px 6px;
    }

    .chat-input-row button {
      font-size: 12px;
      padding: 4px 6px;
    }
  </style>
</head>
<body>
  <div class="coffee-shell">
    <h1>Coffeeâ˜•</h1>

    <div class="row">
      <input id="emojiInput" placeholder="Emoji" maxlength="4" />
      <input id="nameInput" placeholder="Name" maxlength="20" />
    </div>

    <div class="row">
      <button id="hostBtn">Make Coffee</button>
      <button id="joinBtn">Get Coffeeâ˜•</button>
    </div>

    <div class="profile" id="profileBox" style="display:none;">
      <div class="profile-line">
        <span class="profile-emoji" id="profileEmoji">ðŸ™‚</span>
        <span id="profileName">Name</span>
      </div>
      <div class="profile-line">
        <span id="profileDevice">ðŸ“± Android Phone</span>
      </div>
    </div>

    <div class="status" id="status"></div>

    <div class="game-panel" id="gamePanel">
      <select id="gameSelect">
        <option value="">Select a gameâ€¦</option>
        <option value="tictactoe">Tic-Tac-Toe</option>
        <option value="connect4">Connect 4</option>
        <option value="rps">Rockâ€“Paperâ€“Scissors</option>
        <option value="battleship">Battleship (Micro)</option>
        <option value="pong">Pong Duel</option>
        <option value="memory">Memory Match</option>
        <option value="dots">Dots & Boxes</option>
        <option value="reversi">Othello / Reversi</option>
        <option value="wordguess">Word Guess Duel</option>
        <option value="codebreaker">Code Breaker</option>
        <option value="gridchase">Grid Chase</option>
        <option value="war">War (Card Duel)</option>
        <option value="chess">Chess</option>
      </select>
      <button id="startGameBtn">Start Game</button>

      <div class="chat-shell">
        <div class="chat-log" id="chatLog"></div>
        <div class="chat-input-row">
          <input id="chatInput" placeholder="Chatâ€¦" />
          <button id="chatSendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CoffeeScript logic -->
  <script type="text/coffeescript">
    # ===== COFFEE GAME LOGIC (CoffeeScript) =====

    statusEl       = document.getElementById 'status'
    profileBox     = document.getElementById 'profileBox'
    profileEmojiEl = document.getElementById 'profileEmoji'
    profileNameEl  = document.getElementById 'profileName'
    profileDevEl   = document.getElementById 'profileDevice'
    gamePanel      = document.getElementById 'gamePanel'
    gameSelect     = document.getElementById 'gameSelect'
    chatLog        = document.getElementById 'chatLog'
    chatInput      = document.getElementById 'chatInput'

    hostBtn        = document.getElementById 'hostBtn'
    joinBtn        = document.getElementById 'joinBtn'
    startGameBtn   = document.getElementById 'startGameBtn'
    chatSendBtn    = document.getElementById 'chatSendBtn'

    emojiInput     = document.getElementById 'emojiInput'
    nameInput      = document.getElementById 'nameInput'

    isHost         = false
    device         = null
    server         = null
    characteristic = null

    # --- Helper: get a simple device label (for non-@% users) ---
    getDeviceLabel = ->
      ua = navigator.userAgent or ''
      if /Android/i.test ua
        'ðŸ“± Android Phone'
      else if /iPhone|iPad|iPod/i.test ua
        'ðŸ“± iOS Device'
      else if /Windows/i.test ua
        'ðŸ’» Windows PC'
      else if /Macintosh/i.test ua
        'ðŸ’» Mac'
      else
        'ðŸ“± Device'

    # --- Apply profile rules, including @% â†’ ðŸ˜Ž ---
    updateProfile = ->
      emoji = emojiInput.value.trim() or 'ðŸ™‚'
      rawName = nameInput.value.trim() or 'Coffee'
      name = rawName
      specialCool = false

      if rawName.endsWith '@%'
        name = rawName.replace /@%$/, ''
        specialCool = true

      profileEmojiEl.textContent = emoji
      profileNameEl.textContent  = name

      if specialCool
        profileDevEl.textContent = 'ðŸ˜Ž'
      else
        profileDevEl.textContent = getDeviceLabel()

      profileBox.style.display = 'block'

    # --- Status helper ---
    setStatus = (msg) ->
      statusEl.textContent = msg

    # --- Append chat message locally ---
    appendChat = (from, text) ->
      div = document.createElement 'div'
      div.textContent = "#{from}: #{text}"
      chatLog.appendChild div
      chatLog.scrollTop = chatLog.scrollHeight

    # --- Send chat over Bluetooth (if connected) ---
    sendChat = (text) ->
      return unless text.trim().length > 0
      appendChat(if isHost then 'Host' else 'Joiner', text)

      if characteristic?
        payload =
          type: 'chat'
          from: if isHost then 'host' else 'joiner'
          text: text

        data = new TextEncoder().encode JSON.stringify payload
        characteristic.writeValue data
      chatInput.value = ''

    # --- Handle incoming Bluetooth messages ---
    handleMessage = (dataView) ->
      try
        text = new TextDecoder().decode dataView
        msg  = JSON.parse text
        if msg.type is 'chat'
          appendChat(if msg.from is 'host' then 'Host' else 'Joiner', msg.text)
        else if msg.type is 'game-select'
          gameSelect.value = msg.game
        else if msg.type is 'game-start'
          appendChat 'System', "Game started: #{msg.game}"
      catch e
        console.log 'Bad message', e

    # --- Host: Make Coffee (create server) ---
    hostBtn.addEventListener 'click', ->
      isHost = true
      updateProfile()
      setStatus 'Requesting Bluetooth device as hostâ€¦'

      navigator.bluetooth.requestDevice(
        filters: [ { services: [ '0000ffe0-0000-1000-8000-00805f9b34fb' ] } ]
        optionalServices: [ '0000ffe0-0000-1000-8000-00805f9b34fb' ]
      ).then (dev) ->
        device = dev
        setStatus "Connecting to #{dev.name or 'device'}â€¦"
        return dev.gatt.connect()
      .then (serverObj) ->
        server = serverObj
        return server.getPrimaryService '0000ffe0-0000-1000-8000-00805f9b34fb'
      .then (service) ->
        return service.getCharacteristic '0000ffe1-0000-1000-8000-00805f9b34fb'
      .then (char) ->
        characteristic = char
        characteristic.startNotifications().then ->
          characteristic.addEventListener 'characteristicvaluechanged', (event) ->
            handleMessage event.target.value

        setStatus 'Host connected. Waiting in Coffee serverâ€¦'
        gamePanel.style.display = 'block'
      .catch (err) ->
        console.error err
        setStatus 'Host Bluetooth failed or was cancelled.'

    # --- Joiner: Get Coffee (connect to host) ---
    joinBtn.addEventListener 'click', ->
      isHost = false
      updateProfile()
      setStatus 'Searching for Coffee hostâ€¦'

      navigator.bluetooth.requestDevice(
        filters: [ { services: [ '0000ffe0-0000-1000-8000-00805f9b34fb' ] } ]
        optionalServices: [ '0000ffe0-0000-1000-8000-00805f9b34fb' ]
      ).then (dev) ->
        device = dev
        setStatus "Connecting to #{dev.name or 'host'}â€¦"
        return dev.gatt.connect()
      .then (serverObj) ->
        server = serverObj
        return server.getPrimaryService '0000ffe0-0000-1000-8000-00805f9b34fb'
      .then (service) ->
        return service.getCharacteristic '0000ffe1-0000-1000-8000-00805f9b34fb'
      .then (char) ->
        characteristic = char
        characteristic.startNotifications().then ->
          characteristic.addEventListener 'characteristicvaluechanged', (event) ->
            handleMessage event.target.value

        setStatus 'Joined Coffee server.'
        gamePanel.style.display = 'block'
      .catch (err) ->
        console.error err
        setStatus 'Join Bluetooth failed or was cancelled.'

    # --- Host: game selection sync ---
    gameSelect.addEventListener 'change', ->
      return unless isHost and characteristic?
      game = gameSelect.value
      payload =
        type: 'game-select'
        game: game
      data = new TextEncoder().encode JSON.stringify payload
      characteristic.writeValue data

    startGameBtn.addEventListener 'click', ->
      return unless isHost and characteristic?
      game = gameSelect.value
      return unless game
      payload =
        type: 'game-start'
        game: game
      data = new TextEncoder().encode JSON.stringify payload
      characteristic.writeValue data
      appendChat 'System', "Game started: #{game}"

    # --- Chat send ---
    chatSendBtn.addEventListener 'click', ->
      sendChat chatInput.value

    chatInput.addEventListener 'keydown', (e) ->
      if e.key is 'Enter'
        e.preventDefault()
        sendChat chatInput.value
  </script>
</body>
</html>